#!/usr/bin/env bash
# Validate scaf code blocks in docs (best-effort, warns on failures)
# Install: git config core.hooksPath .githooks

DOCS_DIR="src/content/docs"
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

warnings=0
checked=0

# Extract each scaf block individually and try to validate
for mdx in $(find "$DOCS_DIR" -name "*.mdx" 2>/dev/null); do
  # Use awk to extract each block separately
  block_num=0
  awk '/^```scaf$/,/^```$/' "$mdx" 2>/dev/null | while IFS= read -r line; do
    if [[ "$line" == '```scaf' ]]; then
      block_num=$((block_num + 1))
      : > "$TEMP_DIR/block_${block_num}.scaf"
    elif [[ "$line" == '```' ]]; then
      # Block complete, try to validate (silently, partial examples expected to fail)
      if [ -s "$TEMP_DIR/block_${block_num}.scaf" ]; then
        checked=$((checked + 1))
      fi
    else
      echo "$line" >> "$TEMP_DIR/block_${block_num}.scaf" 2>/dev/null || true
    fi
  done
done

# Note: Most doc examples are partial/incomplete by design
# Full validation requires scaf to support --check on snippets
# For now, this hook just ensures the chain works

echo "post-commit: docs hook ran (full scaf validation TODO)"

# Chain to local hooks if they exist
LOCAL_HOOK=".git/hooks/post-commit"
if [ -x "$LOCAL_HOOK" ]; then
  "$LOCAL_HOOK"
fi
